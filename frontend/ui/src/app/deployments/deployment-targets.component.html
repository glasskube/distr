@if (fullVersion) {
  @if (deploymentTargetsWithUpdate$ | async; as updates) {
    @if (updates.length > 0) {
      <div
        class="flex p-4 mb-4 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400"
        role="alert">
        <fa-icon [icon]="faLightbulb" class="me-4"></fa-icon>
        <div>
          <span class="font-medium">Some deployments can be updated:</span>
          <ul class="mt-1.5 list-disc list-inside">
            @for (u of updates; track u.dt.id) {
              <li>
                {{ u.dt.name }}: {{ u.dt.deployment?.applicationName }} &rarr; {{ u.version.name }} (<button
                  type="button"
                  class="font-medium text-blue-600 dark:text-blue-500 hover:underline"
                  (click)="newDeployment(u.dt, deploymentModal, u.version)">
                  update now</button
                >)
              </li>
            }
          </ul>
        </div>
      </div>
    }
  }
}

<div class="flex flex-col gap-4">
  @if (fullVersion) {
    <div class="w-full">
      <div class="items-center justify-between md:flex md:space-x-4">
        <form class="w-full flex-1 md:mr-4 md:max-w-md" [formGroup]="filterForm">
          <label for="default-search" class="sr-only text-sm font-medium text-gray-900 dark:text-white">Search</label>
          <div class="relative">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
              <fa-icon [icon]="faMagnifyingGlass" class="text-gray-500 dark:text-gray-400"></fa-icon>
            </div>
            <input
              type="search"
              id="default-search"
              class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2 pl-10 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="Filter Deployments"
              autotrim
              formControlName="search" />
          </div>
        </form>

        <div class="items-center space-y-4 sm:flex sm:space-x-4 sm:space-y-0 md:mt-0">
          <button
            (click)="openWizard()"
            type="button"
            id="createDeploymentTargetButton2"
            class="w-full md:w-auto flex items-center justify-center py-2 px-4 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
            <fa-icon [icon]="plusIcon" class="text-gray-500 dark:text-gray-400 mr-2"></fa-icon>
            Add deployment
          </button>
        </div>
      </div>
    </div>
  }

  @for (deploymentTarget of filteredDeploymentTargets$ | async; track deploymentTarget.id) {
    <app-deployment-target-card [deploymentTarget]="deploymentTarget" [fullVersion]="fullVersion">
    </app-deployment-target-card>
  }
</div>

<ng-template #deploymentModal>
  <div @modalFlyInOut class="z-50 w-256 max-w-full overflow-x-hidden overflow-y-auto">
    <div class="relative w-full max-h-full">
      <!-- Modal content -->
      <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
        <!-- Modal header -->
        <div
          class="flex items-center justify-between p-4 md:p-5 border-b border-gray-200 rounded-t dark:border-gray-600">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            @if (selectedDeploymentTarget()?.deployment?.id) {
              Update Deployment
            } @else {
              Deploy new application version
            }
          </h3>
          <button
            type="button"
            class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
            (click)="hideModal()">
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <!-- Modal body -->
        <form class="p-4 md:p-5" (ngSubmit)="saveDeployment()">
          @if (selectedDeploymentTarget()?.createdBy?.userRole === 'customer' && auth.hasRole('vendor')) {
            <div
              class="flex items-center p-4 mb-4 text-yellow-800 rounded-lg bg-yellow-50 dark:bg-gray-800 dark:text-yellow-300"
              role="alert">
              <fa-icon [icon]="faCircleExclamation" />
              <span class="sr-only">Info</span>
              <div class="ms-3 text-sm font-medium">
                Warning: You are about to overwrite a customer-managed deployment. Ensure this is done in coordination
                with the customer.
              </div>
            </div>
          }
          <app-deployment-form [formControl]="deployForm"></app-deployment-form>
          <button
            type="submit"
            [disabled]="deployFormLoading"
            class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
            <fa-icon [icon]="shipIcon" class="h-5 w-5 mr-2 -ml-0.5 dark:text-gray-400"></fa-icon>
            Deploy
          </button>
        </form>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #deploymentWizard>
  <app-installation-wizard (closed)="closeWizard()"></app-installation-wizard>
</ng-template>
