<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
  <div class="mx-auto max-w-screen-lg">
    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden">
      <div class="justify-between m-4 sm:m-10 dark:border-gray-700">
        <h1 class="mb-4 text-3xl font-extrabold leading-none tracking-tight text-gray-900 md:text-4xl dark:text-white">
          Subscription
        </h1>
        <p class="text-gray-500 dark:text-gray-400">Manage your Distr subscription and view usage.</p>

        @if (subscriptionInfo(); as subscriptionInfoData) {
          <form [formGroup]="form" (ngSubmit)="checkout()">
            <div class="grid gap-6 mb-4 sm:mb-6 mt-6">
              <!-- Current Usage -->
              <div class="space-y-4">
                <h2 class="text-xl font-bold dark:text-white">Current Usage</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div class="flex flex-col p-4 bg-orange-50 dark:bg-gray-700 rounded-lg text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Users</p>
                    <p class="text-3xl font-bold text-orange-600 dark:text-orange-400 mt-auto">
                      {{ subscriptionInfoData.currentUserAccountCount }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                      @if (
                        subscriptionInfoData.subscriptionUserAccountQuantity &&
                        subscriptionInfoData.subscriptionUserAccountQuantity >= 0
                      ) {
                        of {{ subscriptionInfoData.subscriptionUserAccountQuantity }} licenses used
                      } @else {
                        vendor team members
                      }
                    </p>
                  </div>
                  <div class="flex flex-col p-4 bg-blue-50 dark:bg-gray-700 rounded-lg text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Customers</p>
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-auto">
                      {{ subscriptionInfoData.currentCustomerOrganizationCount }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                      @if (
                        subscriptionInfoData.subscriptionCustomerOrganizationQuantity &&
                        subscriptionInfoData.subscriptionCustomerOrganizationQuantity >= 0
                      ) {
                        of {{ subscriptionInfoData.subscriptionCustomerOrganizationQuantity }} licenses used
                      } @else {
                        end customers
                      }
                      @if (subscriptionInfoData.subscriptionType === 'starter') {
                        <br />
                        <span class="text-xs text-gray-400">
                          ({{ getPlanDisplayName(subscriptionInfoData.subscriptionType) }} max:
                          {{ getCurrentPlanLimit('customerOrganizations') }})
                        </span>
                      }
                    </p>
                  </div>
                  <div class="flex flex-col p-4 bg-green-50 dark:bg-gray-700 rounded-lg text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Most Users per Customer</p>
                    <p class="text-3xl font-bold text-green-600 dark:text-green-400 mt-auto">
                      {{ subscriptionInfoData.currentMaxUsersPerCustomer }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                      of {{ getCurrentPlanLimit('usersPerCustomer') }} allowed
                    </p>
                  </div>
                  <div class="flex flex-col p-4 bg-purple-50 dark:bg-gray-700 rounded-lg text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Most Deployments per Customer</p>
                    <p class="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-auto">
                      {{ subscriptionInfoData.currentMaxDeploymentTargetsPerCustomer }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                      of {{ getCurrentPlanLimit('deploymentsPerCustomer') }} allowed
                    </p>
                  </div>
                </div>
              </div>

              <!-- Current Subscription Info -->
              <div class="space-y-4">
                <h2 class="text-xl font-bold dark:text-white">Current Subscription</h2>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Plan</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">
                      {{ subscriptionInfoData.subscriptionType | titlecase }}
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Period</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">
                      {{ subscriptionInfoData.subscriptionPeriod | titlecase }}
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Ends At</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white">
                      {{ subscriptionInfoData.subscriptionEndsAt | date: 'longDate' }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Manage Subscription (for active subscriptions) -->
              @if (hasActiveSubscription()) {
                <div class="space-y-4">
                  <h2 class="text-xl font-bold dark:text-white">Manage Subscription</h2>
                  <div
                    class="p-6 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-gray-700 dark:to-gray-800 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                      Access the Stripe Customer Portal to manage your subscription, download invoices, and update your
                      payment method.
                    </p>
                    <button
                      type="button"
                      (click)="manageSubscription()"
                      class="text-white inline-flex items-center justify-center bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                      <fa-icon [icon]="faCreditCard" size="lg" class="h-4 w-4 mr-2"></fa-icon>
                      Manage Subscription & Billing
                    </button>
                  </div>
                </div>

                <!-- Change License Quantities -->
                <div class="space-y-4">
                  <h2 class="text-xl font-bold dark:text-white">Change License Quantities</h2>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    Update your license quantities below. Changes will be reflected in your next billing cycle.<br />
                    This is an estimate, please visit our Billing Portal for final prices.
                  </p>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        for="userAccountQuantity-update"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        Internal Users *
                      </label>
                      <input
                        formControlName="userAccountQuantity"
                        type="number"
                        name="userAccountQuantity"
                        id="userAccountQuantity-update"
                        [min]="subscriptionInfoData.currentUserAccountCount"
                        class="bg-gray-50 border border-gray-300 text-sm text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        [placeholder]="subscriptionInfoData.currentUserAccountCount.toString()"
                        required />
                      <p class="mt-1 text-xs font-normal text-gray-500 dark:text-gray-400">
                        Number of internal team members (min: {{ subscriptionInfoData.currentUserAccountCount }})
                      </p>
                    </div>
                    <div>
                      <label
                        for="customerOrganizationQuantity-update"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        Customers *
                      </label>
                      <input
                        formControlName="customerOrganizationQuantity"
                        type="number"
                        name="customerOrganizationQuantity"
                        id="customerOrganizationQuantity-update"
                        [min]="subscriptionInfoData.currentCustomerOrganizationCount"
                        [max]="getCurrentPlanLimit('customerOrganizations')"
                        class="bg-gray-50 border border-gray-300 text-sm text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        [placeholder]="subscriptionInfoData.currentCustomerOrganizationCount.toString()"
                        required />
                      <p class="mt-1 text-xs font-normal text-gray-500 dark:text-gray-400">
                        Number of external customers (min:
                        {{ subscriptionInfoData.currentCustomerOrganizationCount }}, max:
                        {{ getCurrentPlanLimit('customerOrganizations') }})
                      </p>
                    </div>
                  </div>
                  <div class="flex justify-end">
                    <button
                      type="button"
                      (click)="updateQuantities()"
                      [disabled]="form.invalid || !hasQuantitiesChanged()"
                      class="text-white inline-flex items-center justify-center bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 disabled:opacity-60 disabled:cursor-not-allowed">
                      <fa-icon [icon]="faShoppingCart" size="lg" class="h-4 w-4 mr-2"></fa-icon>
                      Proceed
                    </button>
                  </div>
                </div>
              }

              <!-- Plan Selection (for trial subscriptions) -->
              @if (isTrialSubscription()) {
                <div class="space-y-4">
                  <h2 class="text-xl font-bold dark:text-white">Choose Your Plan</h2>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Starter Plan -->
                    <label
                      [class.ring-2]="form.value.subscriptionType === 'starter'"
                      [class.ring-primary-600]="form.value.subscriptionType === 'starter'"
                      [class.opacity-50]="!canSelectStarterPlan()"
                      [class.cursor-not-allowed]="!canSelectStarterPlan()"
                      [class.cursor-pointer]="canSelectStarterPlan()"
                      [class.hover:border-primary-300]="canSelectStarterPlan()"
                      class="flex flex-col p-4 border-2 border-gray-200 rounded-lg dark:border-gray-700 dark:hover:border-primary-700">
                      <input
                        type="radio"
                        formControlName="subscriptionType"
                        value="starter"
                        [disabled]="!canSelectStarterPlan()"
                        class="sr-only" />
                      <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Starter</h3>
                      </div>
                      <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Perfect for initial market validation</p>
                      <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                        <li>✓ {{ getPlanLimits('starter').customers }}</li>
                        <li>✓ {{ getPlanLimits('starter').users }}</li>
                        <li>✓ {{ getPlanLimits('starter').deployments }}</li>
                        <li>✓ Up to 100 GB storage</li>
                      </ul>
                      @if (!canSelectStarterPlan()) {
                        <p class="text-xs text-red-600 dark:text-red-400 mt-2">
                          ⚠️ Your current usage exceeds Starter plan limits
                        </p>
                      }
                    </label>

                    <!-- Pro Plan -->
                    <label
                      [class.ring-2]="form.value.subscriptionType === 'pro'"
                      [class.ring-primary-600]="form.value.subscriptionType === 'pro'"
                      class="flex flex-col p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary-300 dark:border-gray-700 dark:hover:border-primary-700">
                      <input type="radio" formControlName="subscriptionType" value="pro" class="sr-only" />
                      <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Pro</h3>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Most Popular</span>
                      </div>
                      <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Production rollouts with governance</p>
                      <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                        <li>✓ {{ getPlanLimits('pro').customers }} customers</li>
                        <li>✓ {{ getPlanLimits('pro').users }}</li>
                        <li>✓ {{ getPlanLimits('pro').deployments }}</li>
                        <li>✓ Up to 1 TB storage</li>
                        <li>✓ SSO + RBAC, License management</li>
                      </ul>
                    </label>
                  </div>
                </div>

                <!-- subscription period (for trial subscriptions) -->
                <div class="space-y-4">
                  <h2 class="text-xl font-bold dark:text-white">Billing Period</h2>
                  <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        formControlName="subscriptionPeriod"
                        value="monthly"
                        class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                      <span class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Monthly</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        formControlName="subscriptionPeriod"
                        value="yearly"
                        class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                      <span class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">
                        Yearly
                        <span class="text-green-600 dark:text-green-400">(Save 20%)</span>
                      </span>
                    </label>
                  </div>
                </div>

                <!-- Quantities -->
                <div class="space-y-4">
                  <h2 class="text-xl font-bold dark:text-white">License Quantities</h2>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        for="userAccountQuantity-checkout"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        Internal Users *
                      </label>
                      <input
                        formControlName="userAccountQuantity"
                        type="number"
                        name="userAccountQuantity"
                        id="userAccountQuantity-checkout"
                        min="1"
                        class="bg-gray-50 border border-gray-300 text-sm text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="1"
                        required />
                      <p class="mt-1 text-xs font-normal text-gray-500 dark:text-gray-400">
                        Number of internal team members accessing Distr
                      </p>
                    </div>
                    <div>
                      <label
                        for="customerOrganizationQuantity-checkout"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        Customers *
                      </label>
                      <input
                        formControlName="customerOrganizationQuantity"
                        type="number"
                        name="customerOrganizationQuantity"
                        id="customerOrganizationQuantity-checkout"
                        min="0"
                        class="bg-gray-50 border border-gray-300 text-sm text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="1"
                        required />
                      <p class="mt-1 text-xs font-normal text-gray-500 dark:text-gray-400">
                        Number of external customers
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Price Preview -->
                <div
                  class="p-6 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-gray-700 dark:to-gray-800 rounded-lg">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Cost</p>
                      <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ getPreviewPrice() | currency: 'USD' }}
                        <span class="text-lg font-normal text-gray-600 dark:text-gray-400">
                          / {{ form.value.subscriptionPeriod === 'monthly' ? 'month' : 'year' }}
                        </span>
                      </p>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Currency exchange fees might apply.</p>
                    </div>
                    <button
                      type="submit"
                      [disabled]="form.invalid"
                      class="text-white inline-flex items-center justify-center bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 disabled:opacity-60 disabled:cursor-not-allowed">
                      <fa-icon [icon]="faShoppingCart" size="lg" class="h-4 w-4 mr-2"></fa-icon>
                      Proceed to Checkout
                    </button>
                  </div>
                </div>

                <div class="p-4 text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-900 rounded-lg">
                  <p>
                    <strong>Note:</strong>
                    For Enterprise plans with unlimited usage, please
                    <a href="https://distr.sh/contact/" target="_blank" class="text-primary-600 hover:underline"
                      >contact our sales team</a
                    >.
                  </p>
                </div>
              }
            </div>
          </form>
        }
      </div>
    </div>
  </div>

  <ng-template #updateModal>
    @if (pendingUpdate(); as update) {
      <app-subscription-update-modal
        [pendingUpdate]="update"
        (closed)="hideModal()"
        (confirmed)="onModalConfirmed($event)"></app-subscription-update-modal>
    }
  </ng-template>
</section>
