---
apiVersion: v1
kind: ConfigMap
metadata:
  name: glasskube-cloud-agent-env
data:
  GK_TARGET_ID: "{{ .targetId }}"
  GK_LOGIN_ENDPOINT: "{{ .loginEndpoint }}"
  GK_MANIFEST_ENDPOINT: "{{ .manifestEndpoint }}"
  GK_RESOURCE_ENDPOINT: "{{ .resourcesEndpoint }}"
  GK_STATUS_ENDPOINT: "{{ .statusEndpoint }}"
  GK_INTERVAL: "{{ .agentInterval }}"
  GK_AGENT_VERSION_ID: "{{ .agentVersionId }}"

{{ if .targetSecret }}
---
apiVersion: v1
kind: Secret
metadata:
  name: glasskube-cloud-agent-auth
type: Opaque
stringData:
  GK_TARGET_SECRET: "{{ .targetSecret }}"

{{ end }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: glasskube-cloud-agent

{{ if eq .targetScope "namespace" }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: namespace-admin
rules:
  - apiGroups:
      - "*"
    resources:
      - "*"
    verbs:
      - "*"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: glasskube-cloud-agent
subjects:
  - kind: ServiceAccount
    name: glasskube-cloud-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: namespace-admin

{{ else }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: glasskube-cloud-agent
subjects:
  - kind: ServiceAccount
    name: glasskube-cloud-agent
    namespace: {{ .targetNamespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin

{{ end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: glasskube-cloud-agent
spec:
  selector:
    matchLabels:
      app: glasskube-cloud-agent
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: glasskube-cloud-agent
    spec:
      serviceAccountName: glasskube-cloud-agent
      securityContext:
        runAsNonRoot: true
      containers:
        - name: glasskube-cloud-agent
          image: 'ghcr.io/glasskube/cloud/kubernetes-agent:{{ .agentVersion }}'
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: glasskube-cloud-agent-auth
            - configMapRef:
                name: glasskube-cloud-agent-env
          resources:
            limits:
              memory: "128Mi"
              cpu: "500m"
